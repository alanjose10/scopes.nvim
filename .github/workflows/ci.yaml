name: CI
on:
  push:
  pull_request:

jobs:

  tests:
    name: Test
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v4

      - name: Install nvim
        shell: bash
        run: |
          mkdir -p /tmp/nvim
          cd /tmp/nvim

          arch="$(uname -m)"
          case "$arch" in
            x86_64)  asset="nvim-linux-x86_64.appimage" ;;
            aarch64|arm64) asset="nvim-linux-arm64.appimage" ;;
            *) echo "Unsupported arch: $arch"; exit 1 ;;
          esac

          url="https://github.com/neovim/neovim/releases/download/stable/${asset}"

          wget -qO nvim.appimage "$url"
          test -s nvim.appimage || { echo "Downloaded file is empty (bad URL/404?)"; exit 1; }

          chmod a+x ./nvim.appimage
          ./nvim.appimage --appimage-extract
          echo "/tmp/nvim/squashfs-root/usr/bin" >> "$GITHUB_PATH"

      - name: Print nvim version
        run: nvim --version

      - name: Install test dependencies
        run: |
          mkdir -p /tmp/nvim-plugins
          git clone --depth=1 https://github.com/nvim-lua/plenary.nvim     /tmp/nvim-plugins/plenary.nvim
          git clone --depth=1 https://github.com/nvim-treesitter/nvim-treesitter /tmp/nvim-plugins/nvim-treesitter
          git clone --depth=1 https://github.com/folke/snacks.nvim          /tmp/nvim-plugins/snacks.nvim

      - name: Install Treesitter parsers
        run: |
          nvim --headless \
            --cmd "set rtp+=/tmp/nvim-plugins/nvim-treesitter" \
            -c "lua require('nvim-treesitter.install').prefer_git = false" \
            -c "TSInstallSync go lua" \
            -c "qa"

      - name: Run tests
        run: make test
